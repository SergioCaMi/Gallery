  
  <% if (message) { %>
    <div class="message-box" style="color: <%= colorMessage %>">
      <%= message %>
    </div>
  <% } %>

<footer>
      <p>&copy; 2025 Sergio Calvo</p>

</footer>
<script>
    /**
     * Elimina una imagen mediante una solicitud HTTP al servidor.
     *
     * @async
     * @function deleteImage
     * @param {Array} imageId - Array con todos los elementos almacenados en el JSON
     * @returns Una promesa que se resuelve cuando la imagen se elimina correctamente o se rechaza si hay un error.
     */
    async function deleteImage(imageId) {
        const response = await fetch(`/image/${imageId}/delete`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
        });
        if (response.ok) {
            document.getElementById(imageId).style.display = "none";
            window.location.reload(); // Recarga la página tras eliminar para actualizar la galería
        } else {
            console.error("Error al eliminar la imagen");
        }
    }

    /**
     * Descarga una imagen al directorio /downloads
     *
     * @async
     * @function downloadImage
     * @param {imageId} imageId - id de la imagen a descargar
     * @returns Una promesa que se resuelve cuando la imagen se descarga correctamente o se rechaza si hay un error.
     */
    async function downloadImage(imageId) {
        try {
            const response = await fetch(`/image/${imageId}/download`, { method: "GET" });
            if (!response.ok) throw new Error("No se pudo descargar la imagen");
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `imagen-${imageId}.jpg`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            alert("Error al descargar la imagen");
        }
    }

    /**
     * Toggle para mostrar/ocultar el menú desplegable de búsqueda
     */
    function toggleSearch() {
        const dropdown = document.getElementById('searchDropdown');
        const toggleBtn = document.querySelector('.search-toggle-btn');
        
        dropdown.classList.toggle('active');
        toggleBtn.classList.toggle('active');
    }

    // Cerrar menú al hacer click fuera
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('searchDropdown');
        const toggleBtn = document.querySelector('.search-toggle-btn');
        const searchContainer = document.querySelector('.search-menu-container');
        
        if (dropdown && !searchContainer.contains(event.target)) {
            dropdown.classList.remove('active');
            toggleBtn.classList.remove('active');
        }
    });

    /**
     * Limpia los filtros de búsqueda
     */
    function clearSearch() {
        const inputSearch = document.querySelector(".searchInput");
        const inputDateStart = document.querySelector(".dateInput");
        const inputDateEnd = document.querySelector(".dateInputEnd");
        
        if (inputSearch) inputSearch.value = "";
        if (inputDateStart) inputDateStart.value = "";
        if (inputDateEnd) inputDateEnd.value = new Date().toISOString().slice(0,10);
        
        filterCards();
    }

    // BÚSQUEDA REACTIVA POR TÍTULO Y/O FECHA
    (function () {
        const inputSearch = document.querySelector(".searchInput");
        const inputDateStart = document.querySelector(".dateInput");
        const inputDateEnd = document.querySelector(".dateInputEnd");
        const cards = document.querySelectorAll(".card-modern, .card");
        const resultsCount = document.getElementById("resultsCount");
        
        if (!inputSearch || !cards.length) return;

        function filterCards() {
            const searchText = inputSearch.value.toLowerCase();
            const dateStartValue = inputDateStart ? inputDateStart.value : "";
            const dateEndValue = inputDateEnd ? inputDateEnd.value : "";
            let visibleCount = 0;

            cards.forEach((card) => {
                // Buscar título en la nueva estructura o antigua
                const titleElem = card.querySelector(".title-text, #name");
                if (!titleElem) {
                    card.style.display = "none";
                    return;
                }
                
                const cardTitle = titleElem.textContent.replace('Nombre:', '').trim().toLowerCase();
                let matchesTitle = !searchText || cardTitle.includes(searchText);
                let matchesDate = true;

                // Solo filtrar por fecha si se ha especificado una fecha de inicio
                if (dateStartValue) {
                    const searchDateStart = new Date(dateStartValue);
                    const searchDateEnd = dateEndValue ? new Date(dateEndValue) : new Date();
                    
                    // Ajustar al final del día para incluir todo el día final
                    searchDateEnd.setHours(23, 59, 59, 999);
                    
                    const imageDateElem = card.querySelector(".card-date, #date");
                    
                    if (imageDateElem) {
                        const dateText = imageDateElem.textContent.replace('Fecha:', '').trim();
                        const imageDate = new Date(dateText);
                        matchesDate = imageDate >= searchDateStart && imageDate <= searchDateEnd;
                    } else {
                        matchesDate = false;
                    }
                }

                if (matchesTitle && matchesDate) {
                    card.style.display = "";
                    visibleCount++;
                } else {
                    card.style.display = "none";
                }
            });

            // Actualizar contador de resultados - siempre visible
            if (resultsCount) {
                resultsCount.textContent = `${visibleCount} ${visibleCount === 1 ? 'resultado' : 'resultados'}`;
            }
        }

        // Hacer filterCards accesible globalmente
        window.filterCards = filterCards;

        // Inicializar contador al cargar
        filterCards();

        if (inputSearch) inputSearch.addEventListener("input", filterCards);
        if (inputDateStart) inputDateStart.addEventListener("input", filterCards);
        if (inputDateEnd) inputDateEnd.addEventListener("input", filterCards);
    })();
</script>







</script>
</body>

</html>